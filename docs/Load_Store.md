# Load/Store Unit

The Load/Store Unit (LSU) interfaces the core with RAM data memory.
When a load or store instruction is issued, it moves data between the register file and data memory.
This implementation uses purely combinatorial logic


## Ports

#### Parameters

- **`WIDTH = 32`** data width
- **`RAM_ADDR_WIDTH = 10`** word-addressable address width matching size of RAM (4kB)

#### Inputs

- **`lsu_op`** encodes lsu operation
- **`alu_data[WIDTH-1:0]`** data from ALU or calculated memory address
- **`src2[WIDTH-1:0]`** src2 value for store instruction
- **`mem_rd_data[WIDTH-1:0]`** data from memory
- **`dest_reg_i[5:0]`** destination register

#### Outputs

- **`reg_wr_en_o`** register file write enable output
- **`reg_wr_data[WIDTH-1:0]`** register file write data
- **`reg_wr_addr[5:0]`** register file write address
- **`mem_rd_addr[RAM_ADDR_WIDTH-1:0]`** memory read address (word-addressable)
- **`mem_rd_en_o`** memory read enable
- **`mem_wr_addr[RAM_ADDR_WIDTH-1:0]`** memory write address (word-addressable)
- **`mem_wr_data[WIDTH-1:0]`** memory write data
- **`mem_wr_en_o`** memory write enable
- **`misaligned`** asserted if memory address is not 4-byte aligned
- **`access_fault`** asserted if the memory address is outside the address space of the RAM
- **`ex_load_store_n`** indicates if exception was generated by load or store (0=store,1=load)


## Behavior

The LSU performs three tasks:
1. Write the result of ALU operations to the register file
2. Store data from the register file to memory
3. Load data from memory to the register file

Additionally, it detects and signals misaligned memory accesses as well as memory access faults.
The `misaligned` flag should be asserted if `mem_en_i` is high and the address from `alu_data` is not four-byte aligned.
The `access_fault` flag should be asserted if `mem_en_i` is high and the address from `alu_data` has any bit at or higher than bit `RAM_ADDR_WIDTH` set.
If either `misaligned` or `access_fault` is asserted, the outputs `reg_wr_en_o`, `mem_rd_en_o`, and `mem_wr_en_o` should all be low.

The `mem_en_i` and `reg_wr_en_i` control the operation of the LSU.
Table 1. shows how these signals control its behavior.

**Table 1.** LSU operations

| `lsu_op` | operation |
| --- | --- |
| 000 | *nop* |
| 001 | Save `alu_data` to `dest_reg` |
| 010 | Store `src2` to memory at `alu_data` |
| 011 | Load from memory at `alu_data` to `dest_reg` |
| 100 | Write `alu_data` to `csr` |
| 101 | Write `alu_data` to `csr` & save `src2` to `dest_reg` |
| other | *reserved* |


### Memory Mapped Peripherals

A list of all memory mapped peripherals and their address space are listed in Table 2.

**Table 2.** Memory Mapped Peripherals
| Address | Peripheral |
| --- | --- |
| 0xFFFF_FF00 | `timer0` |
| 0xFFFF_FF04 | `timer1` |
| 0xFFFF_FF90 - 0xFFFF_FF9F | `mtime` |
| 0xFFFF_FFA0 - 0xFFFF_FFAF | `GPIOA` |
