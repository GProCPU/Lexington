# Load/Store Unit

The Load/Store Unit (LSU) interfaces the CPU with the following data sources:
- Writes to the Register File
- Writes to CSRs
- Read/Write access to the Data Bus (dbus)

Any instruction writing to the register file does so through the LSU.
Load and store instructions move data between the register file and data memory.
CSR instructions save data to the register file and optionally write to a CSR.

This implementation uses purely combinatorial logic


## Ports

#### Parameters

- **`WIDTH = 32`** data width
- **`REG_ADDR_WIDTH = 5`** register address width
- **`CSR_ADDR_WIDTH = 12`** CSR address width

#### Inputs

- **`lsu_op[2:0]`** encodes lsu operation
- **`alu_result[WIDTH-1:0]`** data from ALU or calculated memory address
- **`alt_data[WIDTH-1:0]`** data source for store and CSR instructions
- **`dest_addr[REG_ADDR_WIDTH-1:0]`** destination register
- **`dbus_rd_data[WIDTH-1:0]`** data from memory
- **`dbus_access_fault`** access fault flag from DBus
- **`endianness`** data memory endianness (0=little,1=big)

#### Outputs

- **`dest_en`** register file write enable output
- **`dest_data[WIDTH-1:0]`** register file write data
- **`dbus_rd_en`** data bus read enable
- **`dbus_wr_en`** data bus write enable
- **`dbus_addr[WIDTH-1:0]`** memory read address (byte-addressable)
- **`dbus_wr_data[WIDTH-1:0]`** memory write data
- **`csr_wr_en`** CSR write enable
- **`csr_wr_data`** CSR write data
- **`data_misaligned`** asserted if memory address is not 4-byte aligned
- **`data_access_fault`** asserted if the memory address is outside the address space of the RAM
- **`load_store_n`** indicates if exception was generated by load or store (0=store,1=load)


## Behavior

The LSU is responsible for detecting misaligned data memory accesses as well as data memory access faults.

- `data_misaligned` is high if `lsu_op` is LSU_STORE or LSU_LOAD and the address `alu_result` is not four-byte aligned (i.e. lowest two bits must be zero), else low.
- `data_access_fault` is hardwired to `dbus_access_fault`.

The `lsu_op` signal controls the operation of the LSU.
Control encoding is shown in Table 1.
The output truth table is shown in Table 2.

**Important:** If either `data_misaligned` or `data_access_fault` is asserted, the outputs `dest_en`, `dbus_rd_en`, `dbus_wr_en`, and `csr_wr_en` should all be low.

**Table 1.** LSU operations

| `lsu_op` | Name | Operation |
| --- | --- | --- |
| 000 | LSU_NOP     | Do nothing |
| 001 | LSU_REG     | Save `alu_result` to `dest_reg` |
| 010 | LSU_STORE   | Store `alt_data` to memory at `alu_result` |
| 011 | LSU_LOAD    | Load from memory at `alu_result` to `dest_reg` |
| 100 | LSU_CSRR    | Save `alt_data` to `dest_reg` |
| 101 | LSU_CSRRW   | Write `alu_result` to `csr` & save `alt_data` to `dest_reg` |
| 110 | *reserved*  | undefined |
| 111 | *reserved*  | undefined |

**Table 2.** LSU truth table

| Port | Output Logic |
| --- | --- |
| `dest_en`         | `lsu_op[0]` or (`lsu_op[2]` and !`lsu_op[1]`)
| `dest_data`       | (`lsu_op[2]`) ? `alt_data` : `alu_result`
| `dbus_rd_en`      | `lsu_op` == LSU_LOAD
| `dbus_wr_en`      | `lsu_op` == LSU_STORE
| `dbus_addr`       | `alu_result`
| `dbus_wr_data`    | `alt_data`
| `csr_wr_en`       | `lsu_op` == LSU_CSRRW
| `csr_wr_data`     | `alu_result`
| `data_misaligned` | `lsu_op[1]` and (`dbus_addr[0]` or `dbus_addr[1]`)
|`data_access_fault`| `dbus_access_fault`
| `load_store_n`    | `lsu_op[0]`

### Memory Mapped Devices

Memory mapped system devices and peripherals are handled the the DBus and AXI interface respectively.
The address map tables for each can be found in the [DBus](./DBus.md) and [AXI4-Lite Crossbar](./AXI4-Lite_Crossbar.md) documents.
